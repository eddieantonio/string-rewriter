#!/usr/bin/env node

const fs = require('fs');
const ProgressBar = require('progress');
const {Corpus, Persist, globalRegistry, findOccurrences} = require('../');

const [_node, _script, filename] = process.argv;
/* Check that the file exists. */
fs.statSync(filename);

const corpus = Corpus.connect(filename);
const persist = Persist.connect();

corpus.size().then(total => {
  const progress = new ProgressBar('[:bar] :percent (:current/:total), :etas left', { total });

  return corpus.forEach(source => {
    persist.addOccurrences(source.hash, findOccurrences(source, globalRegistry))
      .then(progress.tick())
      .catch(err => {
        console.error(err);
        process.exit(-1);
      });
  });
})
.then(() => {
  persist.disconnect();
});

/* vim: set ft=javascript: */
