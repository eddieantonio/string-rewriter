#!/usr/bin/env node

const {statSync} = require('fs');
const ProgressBar = require('progress');
const {Corpus, Persist, globalRegistry, findOccurrences} = require('../');

const [_node, _script, filename, hash] = process.argv;

/* Check that the file exists. */
try {
  statSync(filename);
} catch (e) {
  if (filename) {
    console.error(`Could not find ${filename}`);
  } else {
    console.error(`Must provide a filename`);
  }
  process.exit(-1);
}

if (!hash) {
  console.error(`Hash required`);
  process.exit(-1);
}

const corpus = Corpus.connect(filename);
const persist = Persist.connect();

corpus.get(hash)
.then(source => {
  const occurrences = findOccurrences(source, globalRegistry);
  return persist.addOccurrences(source.hash, occurrences);
})
.then(() => {
  persist.disconnect();
})
.catch(err => {
  console.error(err);
  process.exit(-1);
});

/*eslint no-console: false*/
/*vim: set ft=javascript: */
